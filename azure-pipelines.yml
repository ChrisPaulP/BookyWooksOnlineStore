trigger:
- master

pool:
  vmImage: ubuntu-latest

variables:
  buildConfiguration: 'Release'
  BuildParameters.RestoreBuildProjects: '**/*.csproj'
  BuildParameters.UnitTestProjects: |
    $(BuildParameters.RestoreBuildProjects)
    !**/*FunctionalTests*.csproj
    !**/*IntegrationTests*.csproj
    !**/BookWooks.OrderApi.FunctionalTests.csproj
    !**/BookyWooks.OrderApi.IntegrationTests.csproj
    !**/BookWooks.OrderApi.TestContainersIntegrationTests.csproj
    !**/SagaOrchestration.IntegrationTests.csproj
  BuildParameters.IntegrationTestProjects: |
    **/*IntegrationTests*.csproj
    **/BookWooks.OrderApi.TestContainersIntegrationTests.csproj
    !**/SagaOrchestration.IntegrationTests.csproj

jobs:
- job: BuildAndTest
  displayName: Build and Test with Testcontainers

  steps:
    # ✅ Ensure Docker is running (required for Testcontainers)
    - script: |
        sudo service docker start
        docker info
        docker --version
      displayName: Start Docker

    # ✅ Restore NuGet Packages (all projects)
    - task: DotNetCoreCLI@2
      displayName: Restore NuGet Packages
      inputs:
        command: restore
        projects: $(BuildParameters.RestoreBuildProjects)
        configuration: $(buildConfiguration)

    # ✅ Build the Solution (skip rebuild for test phase)
    - task: DotNetCoreCLI@2
      displayName: Build Solution
      inputs:
        command: build
        projects: |
          **/*.csproj
          !**/SagaOrchestration.IntegrationTests.csproj
        arguments: '--configuration $(buildConfiguration)'

    # ✅ Run Unit Tests (fast)
    - task: DotNetCoreCLI@2
      displayName: Run Unit Tests
      inputs:
        command: test
        projects: $(BuildParameters.UnitTestProjects)
        arguments: --configuration $(buildConfiguration) --no-build --logger trx
      env:
        ASPNETCORE_ENVIRONMENT: Test

    # ✅ Run Integration Tests (Testcontainers optimized for CI)
    - task: DotNetCoreCLI@2
      displayName: Run Integration Tests (Testcontainers)
      inputs:
        command: test
        projects: $(BuildParameters.IntegrationTestProjects)
        arguments: >
          --configuration $(buildConfiguration)
          --no-build
          --logger trx
          --collect:"XPlat Code Coverage"
      env:
        ASPNETCORE_ENVIRONMENT: Test
        TESTCONTAINERS_HOST_OVERRIDE: 'host.docker.internal' # ✅ key change!
        DOTNET_USE_POLLING_FILE_WATCHER: '1'
        DOTNET_RUNNING_IN_CONTAINER: 'false'

    # ✅ Publish Test Results
    - task: PublishTestResults@2
      displayName: Publish Test Results
      condition: succeededOrFailed()
      inputs:
        testResultsFormat: VSTest
        testResultsFiles: '**/TestResults/*.trx'
        mergeTestResults: true

    # ✅ Publish Artifacts (Optional)
    - task: DotNetCoreCLI@2
      displayName: Publish App
      inputs:
        command: publish
        publishWebProjects: false
        projects: $(BuildParameters.RestoreBuildProjects)
        arguments: --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)
        zipAfterPublish: true

    - task: PublishBuildArtifacts@1
      displayName: Publish Artifact
      condition: succeededOrFailed()
      inputs:
        PathtoPublish: $(Build.ArtifactStagingDirectory)
